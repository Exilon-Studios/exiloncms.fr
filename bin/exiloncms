#!/usr/bin/env php
<?php

/**
 * ExilonCMS CLI
 *
 * Global command-line interface for ExilonCMS
 * Usage: exiloncms new <project-name>
 *
 * @package ExilonCMS
 * @author Exilon Studios
 */

const VERSION = '0.2.2';

// Colors for terminal output
const COLORS = [
    'reset' => "\033[0m",
    'bold' => "\033[1m",
    'green' => "\033[32m",
    'yellow' => "\033[33m",
    'blue' => "\033[34m",
    'red' => "\033[31m",
    'cyan' => "\033[36m",
    'magenta' => "\033[35m",
];

function colorize(string $text, string $color = 'reset'): string
{
    return COLORS[$color] . $text . COLORS['reset'];
}

function print_header(string $text): void
{
    echo "\n" . colorize(str_repeat('=', 60), 'bold') . "\n";
    echo colorize("  {$text}", 'bold') . "\n";
    echo colorize(str_repeat('=', 60), 'bold') . "\n\n";
}

function print_success(string $message): void
{
    echo colorize("  OK {$message}", 'green') . "\n";
}

function print_error(string $message): void
{
    echo colorize("  ERROR {$message}", 'red') . "\n";
}

function print_info(string $message): void
{
    echo colorize("  INFO {$message}", 'cyan') . "\n";
}

function print_warn(string $message): void
{
    echo colorize("  WARN {$message}", 'yellow') . "\n";
}

function checkPhpVersion(): bool
{
    $minVersion = '8.2';
    $currentVersion = PHP_VERSION;

    if (version_compare($currentVersion, $minVersion, '<')) {
        print_error("PHP {$minVersion} or higher is required. You are running PHP {$currentVersion}");
        return false;
    }

    print_success("PHP version: {$currentVersion}");
    return true;
}

function checkExtensions(): bool
{
    $required = ['curl', 'zip', 'json', 'mbstring'];
    $missing = [];

    foreach ($required as $ext) {
        if (! extension_loaded($ext)) {
            $missing[] = $ext;
        }
    }

    if (! empty($missing)) {
        print_error("Missing required PHP extensions: " . implode(', ', $missing));
        return false;
    }

    print_success("All required extensions are loaded");
    return true;
}

function ask(string $question, $default = null): string
{
    $prompt = $question;
    if ($default !== null) {
        $prompt .= " [" . colorize($default, 'green') . "]";
    }
    $prompt .= ": ";

    echo colorize($prompt, 'cyan');
    $answer = trim(fgets(STDIN) ?: '');

    return $answer ?: $default;
}

function command_new(array $argv): int
{
    $projectName = $argv[2] ?? null;

    print_header("ExilonCMS " . VERSION);

    // Check environment
    if (! checkPhpVersion() || ! checkExtensions()) {
        return 1;
    }

    // Ask for project name if not provided
    if (! $projectName) {
        echo "\n";
        $projectName = ask('Project name', 'exiloncms');

        if (! preg_match('/^[a-zA-Z0-9_-]+$/', $projectName)) {
            print_error("Invalid project name. Use only letters, numbers, hyphens, and underscores.");
            return 1;
        }
    }

    $targetDir = getcwd() . '/' . $projectName;

    if (is_dir($targetDir)) {
        print_error("Directory already exists: {$targetDir}");
        return 1;
    }

    echo "\n";
    print_info("Creating ExilonCMS project: {$projectName}");
    echo "\n";

    // Download from main branch
    $downloadUrl = "https://github.com/Exilon-Studios/ExilonCMS/archive/refs/heads/main.zip";
    print_info("Downloading from: {$downloadUrl}");

    $tempDir = sys_get_temp_dir() . '/exiloncms-install-' . time();
    mkdir($tempDir, 0755, true);
    $zipPath = $tempDir . '/exiloncms.zip';

    // Download using file_get_contents
    $ctx = stream_context_create([
        'http' => ['timeout' => 300],
        'ssl' => [
            'verify_peer' => false,
            'verify_peer_name' => false,
        ],
    ]);

    $content = @file_get_contents($downloadUrl, false, $ctx);

    if ($content === false) {
        print_error("Failed to download file");
        return 1;
    }

    file_put_contents($zipPath, $content);
    print_success("Download complete");

    // Extract
    print_info("Extracting files...");
    $zip = new ZipArchive();
    if ($zip->open($zipPath) !== TRUE) {
        print_error("Failed to open ZIP archive");
        return 1;
    }

    $extractDir = $tempDir . '/extracted';
    mkdir($extractDir, 0755, true);
    $zip->extractTo($extractDir);
    $zip->close();

    // Find extracted directory
    $extractedDirs = glob($extractDir . '/*', GLOB_ONLYDIR);
    $sourceDir = $extractedDirs[0] ?? null;

    if (! $sourceDir || ! is_dir($sourceDir)) {
        print_error("Failed to find extracted files");
        return 1;
    }

    print_success("Extraction complete");

    // Copy files to target directory
    print_info("Installing to: {$targetDir}");

    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
        // Windows: Use robocopy or xcopy
        mkdir($targetDir, 0755, true);
        $sourceDir = rtrim($sourceDir, '/');
        $targetDir = rtrim($targetDir, '/');

        // Try robocopy first (more reliable)
        $robocopy = exec('where robocopy 2>nul');
        if (!empty($robocopy)) {
            exec("robocopy \"{$sourceDir}\" \"{$targetDir}\" /E /NFL /NDL /NJH /NJS", $output, $ret);
            // Robocopy returns 0-7 for success
            if ($ret < 8) {
                print_success("Files installed successfully");
            } else {
                print_error("Failed to copy files");
                return 1;
            }
        } else {
            // Fallback to xcopy
            exec("xcopy \"{$sourceDir}\" \"{$targetDir}\" /E /I /H /Y /Q", $output, $ret);
            if ($ret === 0) {
                print_success("Files installed successfully");
            } else {
                print_error("Failed to copy files");
                return 1;
            }
        }
    } else {
        // Unix: Use cp -r
        exec("cp -r \"{$sourceDir}\" \"{$targetDir}\"", $output, $ret);
        if ($ret === 0) {
            print_success("Files installed successfully");
        } else {
            print_error("Failed to copy files");
            return 1;
        }
    }

    // Cleanup
    @unlink($zipPath);
    exec((strtoupper(substr(PHP_OS, 0, 3)) === 'WIN' ? "rd /s /q \"{$tempDir}\"" : "rm -rf \"{$tempDir}\""));

    // Copy .env.example to .env
    $envPath = $targetDir . '/.env';
    if (! file_exists($envPath) && file_exists($targetDir . '/.env.example')) {
        copy($targetDir . '/.env.example', $envPath);
        print_success("Created .env file");
    }

    // Generate key
    print_info("Generating application key...");
    $phpBinary = PHP_BINARY;
    exec("cd \"{$targetDir}\" && \"{$phpBinary}\" artisan key:generate 2>&1", $output, $returnCode);
    if ($returnCode === 0) {
        print_success("Application key generated");
    }

    echo "\n";
    print_header("Installation Complete!");

    echo colorize("\nNext steps:\n", 'cyan');
    echo "\n  1. " . colorize("cd {$projectName}", 'green');
    echo "\n  2. " . colorize("composer install", 'green');
    echo "\n  3. " . colorize("npm install", 'green');
    echo "\n  4. " . colorize("npm run build", 'green');
    echo "\n  5. " . colorize("php artisan migrate:fresh --seed", 'green');
    echo "\n  6. " . colorize("php artisan serve", 'green');
    echo "\n\n";

    echo "For more information: " . colorize("https://github.com/Exilon-Studios/ExilonCMS", 'cyan') . "\n\n";

    return 0;
}

function command_version(): int
{
    echo "ExilonCMS CLI version " . VERSION . "\n";
    return 0;
}

function command_help(): int
{
    print_header("ExilonCMS CLI");

    echo "Usage: exiloncms <command> [options]\n\n";

    echo colorize("Commands:\n", 'yellow');
    echo "  " . colorize('new', 'green') . " <name>      Create a new ExilonCMS project\n";
    echo "  " . colorize('version', 'green') . "           Show version information\n";
    echo "  " . colorize('help', 'green') . "              Show this help message\n\n";

    echo colorize("Examples:\n", 'yellow');
    echo "  exiloncms new my-site\n";
    echo "  exiloncms new blog\n";
    echo "  exiloncms version\n\n";

    echo "For more information, visit: " . colorize("https://github.com/Exilon-Studios/ExilonCMS", 'cyan') . "\n\n";

    return 0;
}

// Main
function main(array $argv): int
{
    if (! isset($argv[1])) {
        return command_help();
    }

    $command = $argv[1];

    return match ($command) {
        'new', 'create' => command_new($argv),
        'version', '-v', '--version' => command_version(),
        'help', '-h', '--help' => command_help(),
        default => command_help(),
    };
}

// Run
exit(main($argv));
