#!/usr/bin/env php
<?php

/**
 * ExilonCMS CLI
 *
 * Global command-line interface for ExilonCMS
 * Usage: exiloncms new <project-name>
 *
 * @package ExilonCMS
 * @author Exilon Studios
 */

const VERSION = '0.2.2';

// Colors for terminal output
const COLORS = [
    'reset' => "\033[0m",
    'bold' => "\033[1m",
    'green' => "\033[32m",
    'yellow' => "\033[33m",
    'blue' => "\033[34m",
    'red' => "\033[31m",
    'cyan' => "\033[36m",
    'magenta' => "\033[35m",
];

function colorize(string $text, string $color = 'reset'): string
{
    return COLORS[$color] . $text . COLORS['reset'];
}

function print_header(string $text): void
{
    echo "\n" . colorize(str_repeat('=', 60), 'bold') . "\n";
    echo colorize("  {$text}", 'bold') . "\n";
    echo colorize(str_repeat('=', 60), 'bold') . "\n\n";
}

function print_success(string $message): void
{
    echo colorize("  OK {$message}", 'green') . "\n";
}

function print_error(string $message): void
{
    echo colorize("  ERROR {$message}", 'red') . "\n";
}

function print_info(string $message): void
{
    echo colorize("  INFO {$message}", 'cyan') . "\n";
}

function print_warn(string $message): void
{
    echo colorize("  WARN {$message}", 'yellow') . "\n";
}

function checkPhpVersion(): bool
{
    $minVersion = '8.2';
    $currentVersion = PHP_VERSION;

    if (version_compare($currentVersion, $minVersion, '<')) {
        print_error("PHP {$minVersion} or higher is required. You are running PHP {$currentVersion}");
        return false;
    }

    print_success("PHP version: {$currentVersion}");
    return true;
}

function checkExtensions(): bool
{
    $required = ['curl', 'zip', 'json', 'mbstring'];
    $missing = [];

    foreach ($required as $ext) {
        if (! extension_loaded($ext)) {
            $missing[] = $ext;
        }
    }

    if (! empty($missing)) {
        print_error("Missing required PHP extensions: " . implode(', ', $missing));
        return false;
    }

    print_success("All required extensions are loaded");
    return true;
}

function ask(string $question, $default = null): string
{
    $prompt = $question;
    if ($default !== null) {
        $prompt .= " [" . colorize($default, 'green') . "]";
    }
    $prompt .= ": ";

    echo colorize($prompt, 'cyan');
    $answer = trim(fgets(STDIN) ?: '');

    return $answer ?: $default;
}

function downloadFile(string $url, string $destination): bool
{
    print_info("Downloading from: {$url}");

    // Try file_get_contents first (works better on Windows)
    $ctx = stream_context_create([
        'http' => [
            'timeout' => 300,
            'follow_location' => true,
        ],
        'ssl' => [
            'verify_peer' => false,
            'verify_peer_name' => false,
        ],
    ]);

    $content = @file_get_contents($url, false, $ctx);

    if ($content !== false) {
        file_put_contents($destination, $content);
        print_success("Download complete");
        return true;
    }

    // Fallback to curl
    $fp = fopen($destination, 'w+');
    if (! $fp) {
        print_error("Could not open file for writing: {$destination}");
        return false;
    }

    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $url,
        CURLOPT_FILE => $fp,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_TIMEOUT => 300,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_SSL_VERIFYHOST => false,
        CURLOPT_NOPROGRESS => false,
        CURLOPT_PROGRESSFUNCTION => function ($resource, $downloadSize, $downloaded, $uploadSize, $uploaded) {
            static $lastPercent = 0;
            if ($downloadSize > 0) {
                $percent = intval($downloaded / $downloadSize * 100);
                if ($percent > $lastPercent && $percent % 10 === 0) {
                    $lastPercent = $percent;
                    echo "\r  Downloading: {$percent}%";
                }
            }
            return 0;
        },
    ]);

    $result = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    fclose($fp);

    echo "\r  Downloading: 100%" . str_repeat(' ', 20) . "\n";

    if ($result && $httpCode === 200) {
        print_success("Download complete");
        return true;
    }

    print_error("Download failed (HTTP {$httpCode})");
    @unlink($destination);
    return false;
}

function extractZip(string $zipPath, string $destination): bool
{
    print_info("Extracting to: {$destination}");

    $zip = new ZipArchive();
    $result = $zip->open($zipPath);

    if ($result !== true) {
        print_error("Failed to open ZIP archive: {$result}");
        return false;
    }

    if (! is_dir($destination)) {
        mkdir($destination, 0755, true);
    }

    $zip->extractTo($destination);
    $zip->close();

    print_success("Extraction complete");
    return true;
}

function ask_simple_choice(string $question, array $options, $default = null): string
{
    $keys = array_keys($options);
    $defaultIndex = array_search($default ?? $keys[0], $keys, true);
    if ($defaultIndex === false) {
        $defaultIndex = 0;
    }

    $selectedIndex = $defaultIndex;

    // Save terminal settings
    if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN') {
        system('stty -echo -icanon min 0 time 0');
    }

    echo colorize($question, 'cyan') . "\n\n";

    // Display menu
    while (true) {
        // Clear screen and redraw menu
        echo "\033[" . (count($options) + 2) . "A"; // Move cursor up
        echo "\033[J"; // Clear from cursor to end of screen

        foreach ($options as $i => $label) {
            $key = $keys[$i];
            if ($i === $selectedIndex) {
                echo colorize(" > {$label}", 'green') . "\n";
            } else {
                echo "   {$label}\n";
            }
        }

        echo "\n" . colorize("Use arrow keys to navigate, Enter to select:", 'cyan');

        // Read key
        $key = fread(STDIN, 4);

        // Handle arrow keys (ANSI escape sequences)
        if (isset($key[0]) && $key[0] === "\033") {
            if (isset($key[1]) && $key[1] === '[') {
                if (isset($key[2])) {
                    switch ($key[2]) {
                        case 'A': // Up arrow
                            $selectedIndex = ($selectedIndex - 1 + count($options)) % count($options);
                            break;
                        case 'B': // Down arrow
                            $selectedIndex = ($selectedIndex + 1) % count($options);
                            break;
                    }
                }
            }
        }
        // Enter key
        elseif ($key === "\n" || $key === "\r") {
            echo "\n";
            break;
        }
    }

    // Restore terminal settings
    if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN') {
        system('stty echo icanon');
    }

    return $keys[$selectedIndex];
}

function ask_choice(string $question, array $options, $default = null): string
{
    $keys = array_keys($options);
    $defaultIndex = array_search($default ?? $keys[0], $keys, true);
    if ($defaultIndex === false) {
        $defaultIndex = 0;
    }

    $selectedIndex = $defaultIndex;

    // Save terminal settings
    if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN') {
        system('stty -echo -icanon min 0 time 0');
    }

    echo colorize($question, 'cyan') . "\n\n";

    // Display menu
    while (true) {
        // Clear screen and redraw menu
        echo "\033[" . (count($options) + 2) . "A"; // Move cursor up
        echo "\033[J"; // Clear from cursor to end of screen

        foreach ($options as $i => $label) {
            $key = $keys[$i];
            if ($i === $selectedIndex) {
                echo colorize(" > {$key}. {$label}", 'green') . "\n";
            } else {
                echo "   {$key}. {$label}\n";
            }
        }

        echo "\n" . colorize("Use arrow keys to navigate, Enter to select:", 'cyan');

        // Read key
        $key = fread(STDIN, 4);

        // Handle arrow keys (ANSI escape sequences)
        if (isset($key[0]) && $key[0] === "\033") {
            if (isset($key[1]) && $key[1] === '[') {
                if (isset($key[2])) {
                    switch ($key[2]) {
                        case 'A': // Up arrow
                            $selectedIndex = ($selectedIndex - 1 + count($options)) % count($options);
                            break;
                        case 'B': // Down arrow
                            $selectedIndex = ($selectedIndex + 1) % count($options);
                            break;
                    }
                }
            }
        }
        // Enter key
        elseif ($key === "\n" || $key === "\r") {
            echo "\n";
            break;
        }
    }

    // Restore terminal settings
    if (strtoupper(substr(PHP_OS, 0, 3)) !== 'WIN') {
        system('stty echo icanon');
    }

    return $keys[$selectedIndex];
}

function getMarketplaceData(): array
{
    print_info("Checking marketplace for themes and plugins...");

    $registryUrl = "https://raw.githubusercontent.com/Exilon-Studios/ExilonCMS-marketplace/main/registry.json";

    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $registryUrl,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 10,
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($httpCode === 200 && $response) {
        $data = json_decode($response, true);

        // Check if there are actual themes and plugins
        $hasThemes = !empty($data['themes']) && count($data['themes']) > 0;
        $hasPlugins = !empty($data['plugins']) && count($data['plugins']) > 0;

        if ($hasThemes || $hasPlugins) {
            print_success("Marketplace data loaded");
            return $data;
        }
    }

    // Return empty arrays - no fake defaults!
    return ['themes' => [], 'plugins' => []];
}

function command_new(array $argv): int
{
    $projectName = $argv[2] ?? null;

    print_header("ExilonCMS " . VERSION);

    // Check environment
    if (! checkPhpVersion() || ! checkExtensions()) {
        return 1;
    }

    // Ask for project name if not provided
    if (! $projectName) {
        echo "\n";
        $projectName = ask('Project name', 'exiloncms');

        if (! preg_match('/^[a-zA-Z0-9_-]+$/', $projectName)) {
            print_error("Invalid project name. Use only letters, numbers, hyphens, and underscores.");
            return 1;
        }
    }

    $targetDir = getcwd() . '/' . $projectName;

    if (is_dir($targetDir)) {
        print_error("Directory already exists: {$targetDir}");
        return 1;
    }

    echo "\n";

    // Get marketplace data
    $marketplaceData = getMarketplaceData();
    $hasThemes = !empty($marketplaceData['themes']);
    $hasPlugins = !empty($marketplaceData['plugins']);

    $selectedTheme = null;
    $selectedPlugins = [];

    // Ask about theme if available
    if ($hasThemes) {
        echo "\n";
        $themeOptions = [];
        foreach ($marketplaceData['themes'] as $i => $theme) {
            $themeOptions[$i] = $theme['name'];
        }
        $themeOptions['none'] = 'Skip (use default)';

        echo colorize("Theme Selection", 'yellow') . "\n";

        $themeChoice = ask_simple_choice('Select a theme', $themeOptions, 'none');
        if ($themeChoice !== 'none' && isset($marketplaceData['themes'][$themeChoice])) {
            $selectedTheme = $marketplaceData['themes'][$themeChoice]['id'];
        }
    }

    // Ask about plugins if available
    if ($hasPlugins) {
        echo "\n";
        $pluginOptions = [];
        foreach ($marketplaceData['plugins'] as $i => $plugin) {
            $pluginOptions[$i] = $plugin['name'];
        }
        $pluginOptions['none'] = 'Skip';

        echo colorize("Plugin Selection", 'yellow') . "\n";

        $pluginChoice = ask_simple_choice('Select plugins (enter for none)', $pluginOptions, 'none');

        if ($pluginChoice !== 'none' && isset($marketplaceData['plugins'][$pluginChoice])) {
            $selectedPlugins[] = $marketplaceData['plugins'][$pluginChoice]['id'];
        }
    }

    echo "\n";
    print_info("Creating ExilonCMS project: {$projectName}");
    echo "\n";
    print_info("Database: PostgreSQL (default)");
    print_info("Cache: File (default)");
    echo "\n";

    // Download from main branch (since no release tags exist yet)
    $downloadUrl = "https://github.com/Exilon-Studios/ExilonCMS/archive/refs/heads/main.zip";

    // Create temp directory
    $tempDir = sys_get_temp_dir() . '/exiloncms-install';
    if (! is_dir($tempDir)) {
        mkdir($tempDir, 0755, true);
    }

    $zipPath = $tempDir . '/exiloncms.zip';

    // Download
    if (! downloadFile($downloadUrl, $zipPath)) {
        return 1;
    }

    // Extract
    if (! extractZip($zipPath, $tempDir . '/extracted')) {
        return 1;
    }

    // Find the extracted directory
    $extractedDirs = glob($tempDir . '/extracted/*', GLOB_ONLYDIR);
    $sourceDir = $extractedDirs[0] ?? $tempDir . '/extracted';

    // Move to target directory (copy+delete on Windows for better compatibility)
    print_info("Installing to: {$targetDir}");

    // Try rename first (faster)
    if (! @rename($sourceDir, $targetDir)) {
        // Fallback to recursive copy
        print_info("Copying files...");
        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($sourceDir, RecursiveDirectoryIterator::SKIP_DOTS),
            RecursiveIteratorIterator::SELF_FIRST
        );

        foreach ($iterator as $item) {
            $dest = $targetDir . '/' . $iterator->getSubPathName();
            if ($item->isDir()) {
                mkdir($dest, 0755, true);
            } else {
                copy($item, $dest);
            }
        }

        // Cleanup source
        $cleanupIterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($sourceDir, RecursiveDirectoryIterator::SKIP_DOTS),
            RecursiveIteratorIterator::CHILD_FIRST
        );

        foreach ($cleanupIterator as $item) {
            if ($item->isDir()) {
                rmdir($item);
            } else {
                unlink($item);
            }
        }
        rmdir($sourceDir);
    }

    // Cleanup
    @unlink($zipPath);
    @rmdir($tempDir . '/extracted');
    @rmdir($tempDir);

    print_success("Files installed successfully");

    // Copy .env.example to .env
    $envPath = $targetDir . '/.env';
    if (! file_exists($envPath) && file_exists($targetDir . '/.env.example')) {
        copy($targetDir . '/.env.example', $envPath);
        print_success("Created .env file");
    }

    // Generate key
    print_info("Generating application key...");
    $phpBinary = PHP_BINARY;
    exec("cd {$targetDir} && {$phpBinary} artisan key:generate 2>&1", $output, $returnCode);
    if ($returnCode === 0) {
        print_success("Application key generated");
    }

    echo "\n";
    print_header("Installation Complete!");

    if ($selectedTheme) {
        echo "\n  Theme: " . colorize($selectedTheme, 'green');
    }
    if (! empty($selectedPlugins)) {
        echo "\n  Plugins: " . colorize(implode(', ', $selectedPlugins), 'green');
    }

    echo colorize("\n\nNext steps:\n", 'cyan');
    echo "\n  1. " . colorize("cd {$projectName}", 'green');
    echo "\n  2. " . colorize("composer install", 'green');
    echo "\n  3. " . colorize("npm install", 'green');
    echo "\n  4. " . colorize("npm run build", 'green');
    echo "\n  5. " . colorize("php artisan migrate:fresh --seed", 'green');
    echo "\n  6. " . colorize("php artisan serve", 'green');
    echo "\n\n";

    echo "For more information: " . colorize("https://github.com/Exilon-Studios/ExilonCMS", 'cyan') . "\n\n";

    return 0;
}

function command_version(): int
{
    echo "ExilonCMS CLI version " . VERSION . "\n";
    return 0;
}

function command_help(): int
{
    print_header("ExilonCMS CLI");

    echo "Usage: exiloncms <command> [options]\n\n";

    echo colorize("Commands:\n", 'yellow');
    echo "  " . colorize('new', 'green') . " <name>      Create a new ExilonCMS project\n";
    echo "  " . colorize('version', 'green') . "           Show version information\n";
    echo "  " . colorize('help', 'green') . "              Show this help message\n\n";

    echo colorize("Examples:\n", 'yellow');
    echo "  exiloncms new my-site\n";
    echo "  exiloncms new blog\n";
    echo "  exiloncms version\n\n";

    echo "For more information, visit: " . colorize("https://github.com/Exilon-Studios/ExilonCMS", 'cyan') . "\n\n";

    return 0;
}

// Main
function main(array $argv): int
{
    if (! isset($argv[1])) {
        return command_help();
    }

    $command = $argv[1];

    return match ($command) {
        'new', 'create' => command_new($argv),
        'version', '-v', '--version' => command_version(),
        'help', '-h', '--help' => command_help(),
        default => command_help(),
    };
}

// Run
exit(main($argv));
