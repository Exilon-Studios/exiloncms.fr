#!/usr/bin/env php
<?php

/**
 * ExilonCMS CLI
 *
 * Global command-line interface for ExilonCMS
 * Usage: exiloncms new <project-name>
 *
 * @package ExilonCMS
 * @author Exilon Studios
 */

const VERSION = '0.2.2';

// Colors for terminal output
const COLORS = [
    'reset' => "\033[0m",
    'bold' => "\033[1m",
    'green' => "\033[32m",
    'yellow' => "\033[33m",
    'blue' => "\033[34m",
    'red' => "\033[31m",
    'cyan' => "\033[36m",
    'magenta' => "\033[35m",
];

function colorize(string $text, string $color = 'reset'): string
{
    return COLORS[$color] . $text . COLORS['reset'];
}

function print_header(string $text): void
{
    echo "\n" . colorize(str_repeat('=', 60), 'bold') . "\n";
    echo colorize("  {$text}", 'bold') . "\n";
    echo colorize(str_repeat('=', 60), 'bold') . "\n\n";
}

function print_success(string $message): void
{
    echo colorize("  [SUCCÃˆS] {$message}", 'green') . "\n";
}

function print_error(string $message): void
{
    echo colorize("  [ERREUR] {$message}", 'red') . "\n";
}

function print_info(string $message): void
{
    echo colorize("  [INFO] {$message}", 'cyan') . "\n";
}

function print_warn(string $message): void
{
    echo colorize("  [ATTENTION] {$message}", 'yellow') . "\n";
}

function checkPhpVersion(): bool
{
    $minVersion = '8.2';
    $currentVersion = PHP_VERSION;

    if (version_compare($currentVersion, $minVersion, '<')) {
        print_error("PHP {$minVersion} ou supÃ©rieur est requis. Vous utilisez PHP {$currentVersion}");
        return false;
    }

    print_success("Version PHP: {$currentVersion}");
    return true;
}

function checkExtensions(): bool
{
    $required = ['curl', 'zip', 'json', 'mbstring'];
    $missing = [];

    foreach ($required as $ext) {
        if (! extension_loaded($ext)) {
            $missing[] = $ext;
        }
    }

    if (! empty($missing)) {
        print_error("Extensions PHP requises manquantes: " . implode(', ', $missing));
        return false;
    }

    print_success("Toutes les extensions requises sont chargÃ©es");
    return true;
}

function ask(string $question, $default = null): string
{
    $prompt = $question;
    if ($default !== null) {
        $prompt .= " [" . colorize($default, 'green') . "]";
    }
    $prompt .= ": ";

    echo colorize($prompt, 'cyan');
    $answer = trim(fgets(STDIN) ?: '');

    return $answer ?: $default;
}

function confirm(string $question, bool $default = true): bool
{
    $options = $default ? ['O', 'n'] : ['o', 'N'];
    $prompt = $question . " [" . implode('/', $options) . "]: ";

    echo colorize($prompt, 'cyan');
    $answer = strtolower(trim(fgets(STDIN) ?: ''));

    if ($answer === '') {
        return $default;
    }

    return $answer === 'o' || $answer === 'y';
}

function command_new(array $argv): int
{
    $projectName = $argv[2] ?? null;

    print_header("ExilonCMS " . VERSION);

    // Check environment
    if (! checkPhpVersion() || ! checkExtensions()) {
        return 1;
    }

    // Ask for project name if not provided
    if (! $projectName) {
        echo "\n";
        $projectName = ask('Nom du projet', 'exiloncms');

        if (! preg_match('/^[a-zA-Z0-9_-]+$/', $projectName)) {
            print_error("Nom de projet invalide. Utilisez uniquement des lettres, chiffres, tirets et underscores.");
            return 1;
        }
    }

    $targetDir = getcwd() . '/' . $projectName;

    if (is_dir($targetDir)) {
        print_error("Le rÃ©pertoire existe dÃ©jÃ : {$targetDir}");
        return 1;
    }

    echo "\n";
    print_info("CrÃ©ation du projet ExilonCMS: {$projectName}");
    echo "\n";

    // Download from main branch
    $downloadUrl = "https://github.com/Exilon-Studios/ExilonCMS/archive/refs/heads/main.zip";
    print_info("TÃ©lÃ©chargement depuis: {$downloadUrl}");

    $tempDir = sys_get_temp_dir() . '/exiloncms-install-' . time();
    mkdir($tempDir, 0755, true);
    $zipPath = $tempDir . '/exiloncms.zip';

    // Download using file_get_contents
    $ctx = stream_context_create([
        'http' => ['timeout' => 300],
        'ssl' => [
            'verify_peer' => false,
            'verify_peer_name' => false,
        ],
    ]);

    $content = @file_get_contents($downloadUrl, false, $ctx);

    if ($content === false) {
        print_error("Ã‰chec du tÃ©lÃ©chargement du fichier");
        return 1;
    }

    file_put_contents($zipPath, $content);
    print_success("TÃ©lÃ©chargement terminÃ©");

    // Extract
    print_info("Extraction des fichiers...");
    $zip = new ZipArchive();
    if ($zip->open($zipPath) !== TRUE) {
        print_error("Impossible d'ouvrir l'archive ZIP");
        return 1;
    }

    $extractDir = $tempDir . '/extracted';
    mkdir($extractDir, 0755, true);
    $zip->extractTo($extractDir);
    $zip->close();

    // Find extracted directory
    $extractedDirs = glob($extractDir . '/*', GLOB_ONLYDIR);
    $sourceDir = $extractedDirs[0] ?? null;

    if (! $sourceDir || ! is_dir($sourceDir)) {
        print_error("Impossible de trouver les fichiers extraits");
        return 1;
    }

    print_success("Extraction terminÃ©e");

    // Copy files to target directory
    print_info("Installation dans: {$targetDir}");

    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
        // Windows: Use robocopy or xcopy
        mkdir($targetDir, 0755, true);
        $sourceDir = rtrim($sourceDir, '/');
        $targetDir = rtrim($targetDir, '/');

        // Try robocopy first (more reliable)
        $robocopy = exec('where robocopy 2>nul');
        if (!empty($robocopy)) {
            exec("robocopy \"{$sourceDir}\" \"{$targetDir}\" /E /NFL /NDL /NJH /NJS", $output, $ret);
            // Robocopy returns 0-7 for success
            if ($ret < 8) {
                print_success("Fichiers installÃ©s avec succÃ¨s");
            } else {
                print_error("Ã‰chec de la copie des fichiers");
                return 1;
            }
        } else {
            // Fallback to xcopy
            exec("xcopy \"{$sourceDir}\" \"{$targetDir}\" /E /I /H /Y /Q", $output, $ret);
            if ($ret === 0) {
                print_success("Fichiers installÃ©s avec succÃ¨s");
            } else {
                print_error("Ã‰chec de la copie des fichiers");
                return 1;
            }
        }
    } else {
        // Unix: Use cp -r
        exec("cp -r \"{$sourceDir}\" \"{$targetDir}\"", $output, $ret);
        if ($ret === 0) {
            print_success("Fichiers installÃ©s avec succÃ¨s");
        } else {
            print_error("Ã‰chec de la copie des fichiers");
            return 1;
        }
    }

    // Cleanup
    @unlink($zipPath);
    exec((strtoupper(substr(PHP_OS, 0, 3)) === 'WIN' ? "rd /s /q \"{$tempDir}\"" : "rm -rf \"{$tempDir}\""));

    // Copy .env.example to .env
    $envPath = $targetDir . '/.env';
    if (! file_exists($envPath) && file_exists($targetDir . '/.env.example')) {
        copy($targetDir . '/.env.example', $envPath);
        print_success("Fichier .env crÃ©Ã©");
    }

    // Create SQLite database file
    $dbPath = $targetDir . '/database/database.sqlite';
    $dbDir = dirname($dbPath);
    if (! is_dir($dbDir)) {
        mkdir($dbDir, 0755, true);
    }
    if (! file_exists($dbPath)) {
        touch($dbPath);
        print_success("Base de donnÃ©es SQLite crÃ©Ã©e");
    }

    // Generate key using Laravel artisan command
    print_info("GÃ©nÃ©ration de la clÃ© d'application...");
    exec("cd \"{$targetDir}\" && php artisan key:generate 2>&1", $output, $returnCode);
    if ($returnCode === 0) {
        print_success("ClÃ© d'application gÃ©nÃ©rÃ©e");
    } else {
        print_warn("GÃ©nÃ©ration de clÃ© Ã©chouÃ©e, vous devrez peut-Ãªtre lancer 'php artisan key:generate' manuellement");
    }

    // Create required directories
    $dirs = ['plugins', 'themes', 'storage/logs', 'storage/framework/cache', 'storage/framework/sessions', 'storage/framework/views'];
    foreach ($dirs as $dir) {
        $dirPath = $targetDir . '/' . $dir;
        if (! is_dir($dirPath)) {
            mkdir($dirPath, 0755, true);
        }
    }

    // Install Composer dependencies
    echo "\n";
    print_info("Installation des dÃ©pendances PHP (composer install)...");
    exec("cd \"{$targetDir}\" && composer install --no-interaction 2>&1", $output, $returnCode);
    if ($returnCode === 0) {
        print_success("DÃ©pendances PHP installÃ©es");
    } else {
        print_warn("Composer install a eu des problÃ¨mes, vous devrez peut-Ãªtre le lancer manuellement");
    }

    // Install npm dependencies
    print_info("Installation des dÃ©pendances npm...");
    exec("cd \"{$targetDir}\" && npm install 2>&1", $output, $returnCode);
    if ($returnCode === 0) {
        print_success("DÃ©pendances npm installÃ©es");
    } else {
        print_warn("npm install a eu des problÃ¨mes, vous devrez peut-Ãªtre le lancer manuellement");
    }

    // Build assets
    print_info("Construction des assets frontend...");
    exec("cd \"{$targetDir}\" && npm run build 2>&1", $output, $returnCode);
    if ($returnCode === 0) {
        print_success("Assets construits avec succÃ¨s");
    } else {
        print_warn("La construction a eu des problÃ¨mes, vous devrez peut-Ãªtre la lancer manuellement");
    }

    echo "\n";
    print_header("Installation TerminÃ©e!");

    echo colorize("\nVotre projet est prÃªt! ðŸš€\n", 'green');
    echo "\n" . colorize("Ã‰tapes suivantes:\n", 'yellow');
    echo "\n  " . colorize("1.", 'green') . " Lancer les migrations:";
    echo "\n      " . colorize("cd {$projectName}", 'cyan');
    echo "\n      " . colorize("php artisan migrate:fresh --seed", 'cyan');
    echo "\n";
    echo "\n  " . colorize("2.", 'green') . " DÃ©marrer le serveur:";
    echo "\n      " . colorize("php artisan serve", 'cyan');
    echo "\n";
    echo "\n  " . colorize("C'est tout! ðŸŽ‰", 'green');
    echo "\n  " . colorize("SQLite est utilisÃ© par dÃ©faut - aucune configuration de base de donnÃ©es nÃ©cessaire!", 'cyan');
    echo "\n";
    echo "\n  " . colorize("Pour migrer vers PostgreSQL plus tard:", 'yellow');
    echo "\n      - Allez sur " . colorize("https://neon.tech", 'cyan') . " (gratuit) ou https://supabase.com";
    echo "\n      - Configurez " . colorize("DB_CONNECTION", 'cyan') . " dans " . colorize(".env", 'cyan');
    echo "\n      - Exportez votre DB SQLite depuis le panel admin";
    echo "\n";
    echo "\n  " . colorize("Identifiants par dÃ©faut:", 'yellow');
    echo "\n      Email: " . colorize("admin@example.com", 'cyan');
    echo "\n      Mot de passe: " . colorize("password", 'cyan');
    echo "\n\n";

    echo colorize("Documentation complÃ¨te: ", 'white') . colorize("https://github.com/Exilon-Studios/ExilonCMS/wiki", 'cyan') . "\n\n";

    return 0;
}

function command_version(): int
{
    echo "ExilonCMS CLI version " . VERSION . "\n";
    return 0;
}

function command_help(): int
{
    print_header("ExilonCMS CLI");

    echo "Usage: exiloncms <command> [options]\n\n";

    echo colorize("Commands:\n", 'yellow');
    echo "  " . colorize('new', 'green') . " <name>      Create a new ExilonCMS project\n";
    echo "  " . colorize('version', 'green') . "           Show version information\n";
    echo "  " . colorize('help', 'green') . "              Show this help message\n\n";

    echo colorize("Examples:\n", 'yellow');
    echo "  exiloncms new my-site\n";
    echo "  exiloncms new blog\n";
    echo "  exiloncms version\n\n";

    echo "For more information, visit: " . colorize("https://github.com/Exilon-Studios/ExilonCMS", 'cyan') . "\n\n";

    return 0;
}

// Main
function main(array $argv): int
{
    if (! isset($argv[1])) {
        return command_help();
    }

    $command = $argv[1];

    return match ($command) {
        'new', 'create' => command_new($argv),
        'version', '-v', '--version' => command_version(),
        'help', '-h', '--help' => command_help(),
        default => command_help(),
    };
}

// Run
exit(main($argv));
