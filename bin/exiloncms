#!/usr/bin/env php
<?php

/**
 * ExilonCMS CLI
 *
 * Global command-line interface for ExilonCMS
 * Usage: exiloncms new <project-name>
 *
 * @package ExilonCMS
 * @author Exilon Studios
 */

const VERSION = '0.2.2';

// Colors for terminal output
const COLORS = [
    'reset' => "\033[0m",
    'bold' => "\033[1m",
    'green' => "\033[32m",
    'yellow' => "\033[33m",
    'blue' => "\033[34m",
    'red' => "\033[31m",
    'cyan' => "\033[36m",
    'magenta' => "\033[35m",
];

function colorize(string $text, string $color = 'reset'): string
{
    return COLORS[$color] . $text . COLORS['reset'];
}

function print_header(string $text): void
{
    echo "\n" . colorize(str_repeat('=', 60), 'bold') . "\n";
    echo colorize("  {$text}", 'bold') . "\n";
    echo colorize(str_repeat('=', 60), 'bold') . "\n\n";
}

function print_success(string $message): void
{
    echo colorize("  ‚úÖ {$message}", 'green') . "\n";
}

function print_error(string $message): void
{
    echo colorize("  ‚ùå {$message}", 'red') . "\n";
}

function print_info(string $message): void
{
    echo colorize("  ‚ÑπÔ∏è  {$message}", 'cyan') . "\n";
}

function print_warn(string $message): void
{
    echo colorize("  ‚ö†Ô∏è  {$message}", 'yellow') . "\n";
}

function checkPhpVersion(): bool
{
    $minVersion = '8.2';
    $currentVersion = PHP_VERSION;

    if (version_compare($currentVersion, $minVersion, '<')) {
        print_error("PHP {$minVersion} or higher is required. You are running PHP {$currentVersion}");
        return false;
    }

    print_success("PHP version: {$currentVersion}");
    return true;
}

function checkExtensions(): bool
{
    $required = ['curl', 'zip', 'json', 'mbstring'];
    $missing = [];

    foreach ($required as $ext) {
        if (! extension_loaded($ext)) {
            $missing[] = $ext;
        }
    }

    if (! empty($missing)) {
        print_error("Missing required PHP extensions: " . implode(', ', $missing));
        return false;
    }

    print_success("All required extensions are loaded");
    return true;
}

function ask(string $question, $default = null): string
{
    $prompt = $question;
    if ($default !== null) {
        $prompt .= " [" . colorize($default, 'green') . "]";
    }
    $prompt .= ": ";

    echo colorize($prompt, 'cyan');
    $answer = trim(fgets(STDIN) ?: '');

    return $answer ?: $default;
}

function ask_hidden(string $question): string
{
    echo colorize($question . ": ", 'cyan');

    if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
        // Windows
        $vbScript = tempnam(sys_get_temp_dir(), 'pwd');
        file_put_contents($vbScript, 'Set WshShell = CreateObject("WScript.Shell")' . PHP_EOL . 'WshShell.Run "cmd /c echo " & InputBox("' . addslashes($question) . '" & " && exit", 0, True' . PHP_EOL . 'Set WshShell = Nothing');
        $output = shell_exec("cscript //nologo " . escapeshellarg($vbScript));
        @unlink($vbScript);
        $password = trim(explode(PHP_EOL, $output)[1] ?? '');
    } else {
        // Unix-like systems
        system('stty -echo');
        $password = trim(fgets(STDIN) ?: '');
        system('stty echo');
        echo "\n";
    }

    return $password;
}

function ask_choice(string $question, array $options, $default = null): string
{
    $keys = array_keys($options);
    $defaultKey = $default !== null ? $default : $keys[0];

    echo colorize($question, 'cyan') . "\n";

    foreach ($options as $key => $label) {
        $marker = ($key === $defaultKey) ? colorize('‚Üí', 'green') : ' ';
        echo "  {$marker} {$key}. {$label}\n";
    }

    while (true) {
        echo colorize("  Choose (default: {$defaultKey}): ", 'cyan');
        $answer = trim(fgets(STDIN) ?: '');

        if ($answer === '') {
            return $defaultKey;
        }

        if (isset($options[$answer])) {
            return $answer;
        }

        print_error("Invalid choice. Please try again.");
    }
}

function confirm(string $question, bool $default = true): bool
{
    $options = $default ? ['Y', 'n'] : ['y', 'N'];
    $prompt = $question . " [" . implode('/', $options) . "]: ";

    echo colorize($prompt, 'cyan');
    $answer = strtolower(trim(fgets(STDIN) ?: ''));

    if ($answer === '') {
        return $default;
    }

    return $answer === 'y';
}

function display_table(array $headers, array $rows): void
{
    $maxLengths = array_map('strlen', $headers);

    foreach ($rows as $row) {
        foreach ($row as $i => $cell) {
            $maxLengths[$i] = max($maxLengths[$i], strlen($cell));
        }
    }

    $separator = '+' . str_repeat('-', array_sum($maxLengths) + count($maxLengths) * 3 - 1) . '+';

    echo "\n" . colorize($separator, 'cyan') . "\n";

    // Headers
    echo '|';
    foreach ($headers as $i => $header) {
        echo ' ' . str_pad($header, $maxLengths[$i]) . ' |';
    }
    echo "\n" . colorize($separator, 'cyan') . "\n";

    // Rows
    foreach ($rows as $row) {
        echo '|';
        foreach ($row as $i => $cell) {
            echo ' ' . str_pad($cell, $maxLengths[$i]) . ' |';
        }
        echo "\n";
    }

    echo colorize($separator, 'cyan') . "\n\n";
}

function getLatestRelease(): ?array
{
    print_info("Fetching latest release from GitHub...");

    $url = "https://api.github.com/repos/Exilon-Studios/ExilonCMS/releases/latest";

    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $url,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_USERAGENT => 'ExilonCMS-CLI',
        CURLOPT_TIMEOUT => 30,
        CURLOPT_HTTPHEADER => [
            'Accept: application/vnd.github.v3+json',
        ],
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($httpCode === 200 && $response) {
        $data = json_decode($response, true);
        print_success("Found release: {$data['tag_name']}");
        return $data;
    }

    print_warn("Could not fetch release info, using default version");
    return null;
}

function downloadFile(string $url, string $destination): bool
{
    print_info("Downloading from: {$url}");

    $fp = fopen($destination, 'w+');
    if (! $fp) {
        print_error("Could not open file for writing: {$destination}");
        return false;
    }

    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $url,
        CURLOPT_FILE => $fp,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_TIMEOUT => 300,
        CURLOPT_NOPROGRESS => false,
        CURLOPT_PROGRESSFUNCTION => function ($resource, $downloadSize, $downloaded, $uploadSize, $uploaded) {
            static $lastPercent = 0;
            if ($downloadSize > 0) {
                $percent = intval($downloaded / $downloadSize * 100);
                if ($percent > $lastPercent && $percent % 10 === 0) {
                    $lastPercent = $percent;
                    echo "\r  Downloading: {$percent}%";
                }
            }
            return 0;
        },
    ]);

    $result = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    fclose($fp);

    echo "\r  Downloading: 100%" . str_repeat(' ', 20) . "\n";

    if ($result && $httpCode === 200) {
        print_success("Download complete");
        return true;
    }

    print_error("Download failed (HTTP {$httpCode})");
    @unlink($destination);
    return false;
}

function extractZip(string $zipPath, string $destination): bool
{
    print_info("Extracting to: {$destination}");

    $zip = new ZipArchive();
    $result = $zip->open($zipPath);

    if ($result !== true) {
        print_error("Failed to open ZIP archive: {$result}");
        return false;
    }

    if (! is_dir($destination)) {
        mkdir($destination, 0755, true);
    }

    $zip->extractTo($destination);
    $zip->close();

    print_success("Extraction complete");
    return true;
}

function getMarketplaceData(): array
{
    print_info("Fetching marketplace data...");

    $registryUrl = "https://raw.githubusercontent.com/Exilon-Studios/ExilonCMS-marketplace/main/registry.json";

    $ch = curl_init();
    curl_setopt_array($ch, [
        CURLOPT_URL => $registryUrl,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 10,
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($httpCode === 200 && $response) {
        $data = json_decode($response, true);
        print_success("Marketplace data fetched");
        return $data;
    }

    print_warn("Using default marketplace data");
    return [
        'themes' => [
            ['id' => 'default', 'name' => 'Default Theme', 'description' => 'Clean and modern'],
            ['id' => 'gaming', 'name' => 'Gaming Theme', 'description' => 'Dark theme for gaming'],
        ],
        'plugins' => [
            ['id' => 'discord', 'name' => 'Discord Integration', 'description' => 'Link Discord server'],
            ['id' => 'shop', 'name' => 'Shop System', 'description' => 'Virtual shop'],
            ['id' => 'voting', 'name' => 'Voting System', 'description' => 'Player voting'],
        ],
    ];
}

function runInteractiveInstall(string $projectPath): void
{
    print_info("Starting interactive installation...\n");

    $composerPath = $projectPath . '/composer.phar';
    if (! file_exists($composerPath)) {
        $composerPath = $projectPath . '/composer';
    }

    if (! file_exists($composerPath)) {
        print_warn("Composer not found, downloading composer.phar...");
        $composerUrl = 'https://getcomposer.org/composer-stable.phar';
        downloadFile($composerUrl, $projectPath . '/composer.phar');
        $composerPath = $projectPath . '/composer.phar';
    }

    $phpBinary = PHP_BINARY;

    // Run the Laravel install:interactive command
    $command = "{$phpBinary} {$projectPath}/artisan install:interactive";

    echo "\n";
    passthru($command, $returnCode);

    if ($returnCode !== 0) {
        print_error("Interactive setup failed. You can run it manually later:");
        echo colorize("  cd {$projectPath} && php artisan install:interactive\n", 'cyan');
    }
}

function command_new(array $argv): int
{
    $projectName = $argv[2] ?? null;

    print_header("ExilonCMS " . VERSION);

    // Check environment
    if (! checkPhpVersion() || ! checkExtensions()) {
        return 1;
    }

    // Ask for project name if not provided
    if (! $projectName) {
        echo "\n";
        $projectName = ask('Project name', 'exiloncms');

        if (! preg_match('/^[a-zA-Z0-9_-]+$/', $projectName)) {
            print_error("Invalid project name. Use only letters, numbers, hyphens, and underscores.");
            return 1;
        }
    }

    $targetDir = getcwd() . '/' . $projectName;

    if (is_dir($targetDir)) {
        print_error("Directory already exists: {$targetDir}");
        return 1;
    }

    echo "\n";

    // Get marketplace data for questions
    $marketplaceData = getMarketplaceData();

    // Ask questions
    echo colorize("üìã Basic Information", 'yellow') . "\n\n";

    $siteName = ask('Site name', $projectName);
    $siteUrl = ask('Site URL', 'http://localhost:8000');
    $locale = ask_choice('Language', ['en' => 'English', 'fr' => 'French'], 'en');
    $timezone = ask('Timezone', 'UTC');

    echo "\n" . colorize("üíæ Database Configuration", 'yellow') . "\n\n";

    $dbType = ask_choice('Database type', [
        '1' => 'PostgreSQL (Recommended)',
        '2' => 'MySQL/MariaDB',
        '3' => 'SQLite (Development only)',
    ], '1');

    $dbConnection = match ($dbType) {
        '1' => 'pgsql',
        '2' => 'mysql',
        '3' => 'sqlite',
    };

    $dbHost = '127.0.0.1';
    $dbPort = $dbConnection === 'pgsql' ? '5432' : '3306';
    $dbDatabase = 'exiloncms';
    $dbUsername = 'root';
    $dbPassword = '';

    if ($dbConnection !== 'sqlite') {
        $dbHost = ask('Database host', $dbHost);
        $dbPort = ask('Database port', $dbPort);
        $dbDatabase = ask('Database name', $dbDatabase);
        $dbUsername = ask('Database username', $dbUsername);
        $dbPassword = ask_hidden('Database password');
    }

    echo "\n" . colorize("‚ö° Cache & Session", 'yellow') . "\n\n";

    $cacheDriver = ask_choice('Cache driver', [
        '1' => 'File (Development)',
        '2' => 'Redis (Recommended for production)',
        '3' => 'Memcached',
    ], '1');

    $cacheDriver = match ($cacheDriver) {
        '1' => 'file',
        '2' => 'redis',
        '3' => 'memcached',
    };

    $sessionDriver = ask_choice('Session driver', [
        '1' => 'File',
        '2' => 'Redis',
        '3' => 'Database',
    ], '1');

    $sessionDriver = match ($sessionDriver) {
        '1' => 'file',
        '2' => 'redis',
        '3' => 'database',
    };

    echo "\n" . colorize("üë§ Admin Account", 'yellow') . "\n\n";

    $adminName = ask('Admin name', 'Admin');
    $adminEmail = ask('Admin email', 'admin@example.com');
    $adminPassword = ask_hidden('Admin password');

    echo "\n" . colorize("üé® Theme Selection", 'yellow') . "\n\n";

    $themes = $marketplaceData['themes'] ?? [];
    $themeOptions = [];
    foreach ($themes as $i => $theme) {
        $themeOptions[$i + 1] = "{$theme['name']} - {$theme['description']}";
    }
    $themeOptions['none'] = 'Skip (use default)';

    if (count($themes) > 0) {
        display_table(['Theme', 'Description'], $themes);
        $themeChoice = ask_choice('Select a theme', $themeOptions, 'none');
        $selectedTheme = $themeChoice !== 'none' ? $themes[$themeChoice - 1]['id'] : null;
    }

    echo "\n" . colorize("üîå Plugin Selection", 'yellow') . "\n";
    print_info("Select the plugins you want to install (comma-separated numbers, or enter to skip):\n");

    $plugins = $marketplaceData['plugins'] ?? [];
    $pluginOptions = [];
    foreach ($plugins as $i => $plugin) {
        $pluginOptions[$i + 1] = "{$plugin['name']} - {$plugin['description']}";
    }

    $selectedPlugins = [];
    if (count($plugins) > 0) {
        display_table(['Plugin', 'Description'], $plugins);
        $pluginsChoice = ask('Select plugins', 'none');

        if ($pluginsChoice !== 'none') {
            $selectedArray = array_map('trim', explode(',', $pluginsChoice));
            foreach ($selectedArray as $selection) {
                $index = (int) $selection - 1;
                if (isset($plugins[$index])) {
                    $selectedPlugins[] = $plugins[$index]['id'];
                }
            }
        }
    }

    echo "\n" . colorize("‚öôÔ∏è  Additional Options", 'yellow') . "\n\n";

    $createDocker = confirm('Create Docker configuration?', true);
    $runMigrations = confirm('Run database migrations?', true);
    $buildAssets = confirm('Build frontend assets?', true);
    $generateKey = confirm('Generate application key?', true);

    // Summary
    echo "\n" . str_repeat('=', 60) . "\n";
    echo colorize("üìã Installation Summary", 'blue') . "\n";
    echo str_repeat('=', 60) . "\n\n";

    echo colorize("Project:", 'cyan') . " {$projectName}\n";
    echo colorize("Site Name:", 'cyan') . " {$siteName}\n";
    echo colorize("Site URL:", 'cyan') . " {$siteUrl}\n";
    echo colorize("Language:", 'cyan') . " {$locale}\n";
    echo colorize("Database:", 'cyan') . " {$dbConnection}\n";
    echo colorize("Cache:", 'cyan') . " {$cacheDriver}\n";
    echo colorize("Admin:", 'cyan') . " {$adminName} ({$adminEmail})\n";
    if ($selectedTheme) {
        echo colorize("Theme:", 'cyan') . " {$selectedTheme}\n";
    }
    if (! empty($selectedPlugins)) {
        echo colorize("Plugins:", 'cyan') . " " . implode(', ', $selectedPlugins) . "\n";
    }

    echo "\n";

    if (! confirm('Continue with installation?', true)) {
        print_info("Installation cancelled.");
        return 0;
    }

    echo "\n" . colorize("üöÄ Starting Installation...", 'blue') . "\n\n";

    // Get latest release
    $release = getLatestRelease();
    $version = $release['tag_name'] ?? VERSION;

    // Find download URL
    $downloadUrl = null;
    if ($release && isset($release['assets'])) {
        foreach ($release['assets'] as $asset) {
            if (str_ends_with($asset['name'], '.zip')) {
                $downloadUrl = $asset['browser_download_url'];
                break;
            }
        }
    }

    if (! $downloadUrl) {
        $downloadUrl = "https://github.com/Exilon-Studios/ExilonCMS/archive/refs/tags/{$version}.zip";
    }

    // Create temp directory
    $tempDir = sys_get_temp_dir() . '/exiloncms-install';
    if (! is_dir($tempDir)) {
        mkdir($tempDir, 0755, true);
    }

    $zipPath = $tempDir . '/exiloncms.zip';

    // Download
    if (! downloadFile($downloadUrl, $zipPath)) {
        return 1;
    }

    // Extract
    if (! extractZip($zipPath, $tempDir . '/extracted')) {
        return 1;
    }

    // Find the extracted directory
    $extractedDirs = glob($tempDir . '/extracted/*', GLOB_ONLYDIR);
    $sourceDir = $extractedDirs[0] ?? $tempDir . '/extracted';

    // Move to target directory
    print_info("Installing to: {$targetDir}");
    if (! rename($sourceDir, $targetDir)) {
        print_error("Failed to move files to target directory");
        return 1;
    }

    // Cleanup
    @unlink($zipPath);
    @rmdir($tempDir . '/extracted');
    @rmdir($tempDir);

    print_success("Files installed successfully");

    // Create .env file with user's answers
    $envPath = $targetDir . '/.env';
    if (! file_exists($envPath)) {
        copy($targetDir . '/.env.example', $envPath);
    }

    $envContent = file_get_contents($envPath);

    $replacements = [
        'APP_NAME=' => 'APP_NAME=' . $siteName,
        'APP_URL=' => 'APP_URL=' . $siteUrl,
    ];

    if ($dbConnection === 'sqlite') {
        $replacements['DB_CONNECTION='] = 'DB_CONNECTION=sqlite';
        $replacements['DB_DATABASE='] = 'DB_DATABASE=' . $targetDir . '/database/exiloncms.sqlite';
    } else {
        $replacements['DB_CONNECTION='] = 'DB_CONNECTION=' . $dbConnection;
        $replacements['DB_HOST='] = 'DB_HOST=' . $dbHost;
        $replacements['DB_PORT='] = 'DB_PORT=' . $dbPort;
        $replacements['DB_DATABASE='] = 'DB_DATABASE=' . $dbDatabase;
        $replacements['DB_USERNAME='] = 'DB_USERNAME=' . $dbUsername;
        $replacements['DB_PASSWORD='] = 'DB_PASSWORD=' . $dbPassword;
    }

    $replacements['CACHE_DRIVER='] = 'CACHE_DRIVER=' . $cacheDriver;
    $replacements['SESSION_DRIVER='] = 'SESSION_DRIVER=' . $sessionDriver;

    $envContent = str_replace(array_keys($replacements), array_values($replacements), $envContent);
    file_put_contents($envPath, $envContent);

    // Generate key
    if ($generateKey) {
        print_info("Generating application key...");
        $phpBinary = PHP_BINARY;
        exec("cd {$targetDir} && {$phpBinary} artisan key:generate");
    }

    // Install Composer dependencies
    print_info("Installing Composer dependencies...");
    exec("cd {$targetDir} && composer install --no-interaction 2>&1", $output, $returnCode);

    if ($returnCode !== 0) {
        print_warn("Composer install had warnings, but continuing...");
    } else {
        print_success("Composer dependencies installed");
    }

    // Install npm dependencies
    print_info("Installing npm dependencies...");
    exec("cd {$targetDir} && npm install 2>&1", $output, $returnCode);

    if ($returnCode !== 0) {
        print_warn("npm install had issues, you may need to run it manually.");
    } else {
        print_success("npm dependencies installed");
    }

    // Build assets
    if ($buildAssets) {
        print_info("Building frontend assets...");
        exec("cd {$targetDir} && npm run build 2>&1", $output, $returnCode);
        if ($returnCode === 0) {
            print_success("Assets built successfully");
        }
    }

    // Run migrations
    if ($runMigrations) {
        print_info("Running database migrations...");
        exec("cd {$targetDir} && php artisan migrate --seed --force 2>&1", $output, $returnCode);
        if ($returnCode === 0) {
            print_success("Migrations completed");
        }
    }

    // Create admin user
    print_info("Creating admin user...");
    $command = sprintf(
        'php artisan user:create --admin --name="%s" --email="%s" --password="%s"',
        $adminName,
        $adminEmail,
        $adminPassword
    );
    exec("cd {$targetDir} && {$command} 2>&1", $output, $returnCode);
    if ($returnCode === 0) {
        print_success("Admin user created");
    }

    echo "\n" . colorize("‚úÖ Installation Complete!", 'green') . "\n\n";

    echo colorize("Next Steps:\n", 'yellow');

    echo "\n  1. " . colorize("cd {$projectName}", 'cyan');

    if ($createDocker) {
        echo "\n  2. " . colorize("docker-compose up -d", 'cyan');
        echo "\n  3. " . colorize("Visit {$siteUrl}", 'cyan');
    } else {
        echo "\n  2. " . colorize("php artisan serve", 'cyan');
        echo "\n  3. " . colorize("Visit http://localhost:8000", 'cyan');
    }

    echo "\n\nAdmin Login:\n";
    echo "  Email: " . colorize($adminEmail, 'cyan') . "\n";
    echo "  Password: " . colorize("[your password]", 'cyan') . "\n";

    echo "\nFor more information, visit: " . colorize("https://github.com/Exilon-Studios/ExilonCMS", 'cyan') . "\n\n";

    return 0;
}

function command_version(): int
{
    echo "ExilonCMS CLI version " . VERSION . "\n";
    return 0;
}

function command_help(): int
{
    print_header("ExilonCMS CLI");

    echo "Usage: exiloncms <command> [options]\n\n";

    echo colorize("Commands:\n", 'yellow');
    echo "  " . colorize('new', 'green') . " <name>      Create a new ExilonCMS project\n";
    echo "  " . colorize('version', 'green') . "           Show version information\n";
    echo "  " . colorize('help', 'green') . "              Show this help message\n\n";

    echo colorize("Examples:\n", 'yellow');
    echo "  exiloncms new my-site\n";
    echo "  exiloncms new blog --theme=gaming\n";
    echo "  exiloncms version\n\n";

    echo "For more information, visit: " . colorize("https://github.com/Exilon-Studios/ExilonCMS", 'cyan') . "\n\n";

    return 0;
}

// Main
function main(array $argv): int
{
    if (! isset($argv[1])) {
        return command_help();
    }

    $command = $argv[1];

    return match ($command) {
        'new', 'create' => command_new($argv),
        'version', '-v', '--version' => command_version(),
        'help', '-h', '--help' => command_help(),
        default => command_help(),
    };
}

// Run
exit(main($argv));
