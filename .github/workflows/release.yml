name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build:all

      - name: Create release directory
        run: |
          mkdir -p release
          mkdir -p release/exiloncms

      - name: Copy CMS files (excluding development files)
        run: |
          # Copy application files
          rsync -av --exclude='node_modules' \
                      --exclude='.git' \
                      --exclude='.github' \
                      --exclude='.idea' \
                      --exclude='.vscode' \
                      --exclude='tests' \
                      --exclude='phpunit.xml' \
                      --exclude='package-lock.json' \
                      --exclude='composer.lock' \
                      --exclude='.gitignore' \
                      --exclude='CLAUDE.md' \
                      --exclude='CHANGELOG.md' \
                      --exclude='RELEASE.md' \
                      --exclude='screenshots' \
                      --exclude='*.log' \
                      . release/exiloncms/

          # Create storage directories structure
          mkdir -p release/exiloncms/storage/framework/cache
          mkdir -p release/exiloncms/storage/framework/sessions
          mkdir -p release/exiloncms/storage/framework/views
          mkdir -p release/exiloncms/storage/logs
          mkdir -p release/exiloncms/public/storage

          # Create .gitkeep files
          touch release/exiloncms/storage/framework/cache/.gitkeep
          touch release/exiloncms/storage/framework/sessions/.gitkeep
          touch release/exiloncms/storage/framework/views/.gitkeep
          touch release/exiloncms/storage/logs/.gitkeep

          # Create .env from .env.example if it exists
          if [ -f release/exiloncms/.env.example ]; then
            cp release/exiloncms/.env.example release/exiloncms/.env
          fi

      - name: Create release ZIP
        run: |
          cd release
          zip -r ../exiloncms-${{ github.ref_name }}.zip exiloncms/
          cd ..

      - name: Create installer ZIP
        run: |
          # Create standalone installer ZIP
          zip -r exiloncms-installer-${{ github.ref_name }}.zip installer/

      - name: Generate checksums
        run: |
          # CMS checksums
          sha256sum exiloncms-${{ github.ref_name }}.zip > exiloncms-${{ github.ref_name }}.zip.sha256
          md5sum exiloncms-${{ github.ref_name }}.zip > exiloncms-${{ github.ref_name }}.zip.md5
          # Installer checksums
          sha256sum exiloncms-installer-${{ github.ref_name }}.zip > exiloncms-installer-${{ github.ref_name }}.zip.sha256
          md5sum exiloncms-installer-${{ github.ref_name }}.zip > exiloncms-installer-${{ github.ref_name }}.zip.md5

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸš€ ExilonCMS ${{ steps.get_version.outputs.version }}

          ### Installation
          ```bash
          # Option 1: Standalone installer (recommended)
          wget https://github.com/Exilon-Studios/ExilonCMS/releases/download/${{ steps.get_version.outputs.version }}/exiloncms-installer-${{ steps.get_version.outputs.version }}.zip
          unzip exiloncms-installer-${{ steps.get_version.outputs.version }}.zip
  cd installer
  php -S localhost:8000
  # Then open http://localhost:8000 in your browser

          # Option 2: Full CMS package (manual setup)
          wget https://github.com/Exilon-Studios/ExilonCMS/releases/download/${{ steps.get_version.outputs.version }}/exiloncms-${{ steps.get_version.outputs.version }}.zip
          unzip exiloncms-${{ steps.get_version.outputs.version }}.zip
          cd exiloncms
          composer install
          php artisan key:generate
          php artisan migrate --seed
          ```

          ### Upgrading
          If you're already running ExilonCMS, use the built-in update system in the admin panel at `/admin/updates`.

          ### What's Changed
          See the full changelog at https://github.com/Exilon-Studios/ExilonCMS/blob/main/CHANGELOG.md

          ### Downloads
          #### CMS Package
          - ðŸ“¦ **exiloncms-${{ steps.get_version.outputs.version }}.zip** - Full CMS package
          ðŸ” **SHA256**: $(cat exiloncms-${{ steps.get_version.outputs.version }}.zip.sha256 | cut -d' ' -f1)
          ðŸ”‘ **MD5**: $(cat exiloncms-${{ steps.get_version.outputs.version }}.zip.md5 | cut -d' ' -f1)

          #### Standalone Installer
          - ðŸš€ **exiloncms-installer-${{ steps.get_version.outputs.version }}.zip** - Web installer (downloads CMS automatically)
          ðŸ” **SHA256**: $(cat exiloncms-installer-${{ steps.get_version.outputs.version }}.zip.sha256 | cut -d' ' -f1)
          ðŸ”‘ **MD5**: $(cat exiloncms-installer-${{ steps.get_version.outputs.version }}.zip.md5 | cut -d' ' -f1)

          ### Requirements
          - PHP 8.2 or higher
          - Composer 2.x
          - SQLite 3.8+ (included) or PostgreSQL 10+ or MySQL 8+
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: ExilonCMS ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            exiloncms-${{ steps.get_version.outputs.version }}.zip
            exiloncms-${{ steps.get_version.outputs.version }}.zip.sha256
            exiloncms-${{ steps.get_version.outputs.version }}.zip.md5
            exiloncms-installer-${{ steps.get_version.outputs.version }}.zip
            exiloncms-installer-${{ steps.get_version.outputs.version }}.zip.sha256
            exiloncms-installer-${{ steps.get_version.outputs.version }}.zip.md5
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger marketplace webhook
        run: |
          # Notify marketplace of new release
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"version":"${{ steps.get_version.outputs.version }}","download_url":"https://github.com/Exilon-Studios/ExilonCMS/releases/download/${{ steps.get_version.outputs.version }}/exiloncms-${{ steps.get_version.outputs.version }}.zip"}' \
            https://marketplace.exiloncms.fr/api/webhook/release \
            || echo "Marketplace webhook notification skipped"
