name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: Install Composer dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build:all

      - name: Create release directory
        run: |
          mkdir -p release
          mkdir -p release/exiloncms

      - name: Copy CMS files (excluding development files)
        run: |
          # Copy application files
          rsync -av --exclude='node_modules' \
                      --exclude='.git' \
                      --exclude='.github' \
                      --exclude='.idea' \
                      --exclude='.vscode' \
                      --exclude='tests' \
                      --exclude='phpunit.xml' \
                      --exclude='package-lock.json' \
                      --exclude='composer.lock' \
                      --exclude='.gitignore' \
                      --exclude='CLAUDE.md' \
                      --exclude='CHANGELOG.md' \
                      --exclude='RELEASE.md' \
                      --exclude='screenshots' \
                      --exclude='*.log' \
                      --exclude='release' \
                      . release/exiloncms/

          # Create storage directories structure
          mkdir -p release/exiloncms/storage/framework/cache
          mkdir -p release/exiloncms/storage/framework/sessions
          mkdir -p release/exiloncms/storage/framework/views
          mkdir -p release/exiloncms/storage/logs
          mkdir -p release/exiloncms/public/storage

          # Create .gitkeep files
          touch release/exiloncms/storage/framework/cache/.gitkeep
          touch release/exiloncms/storage/framework/sessions/.gitkeep
          touch release/exiloncms/storage/framework/views/.gitkeep
          touch release/exiloncms/storage/logs/.gitkeep

          # Create .env from .env.example if it exists
          if [ -f release/exiloncms/.env.example ]; then
            cp release/exiloncms/.env.example release/exiloncms/.env
          fi

      - name: Create release ZIP
        run: |
          cd release
          zip -r ../exiloncms-${{ github.ref_name }}.zip exiloncms/
          cd ..

      - name: Create update ZIP (lightweight, without vendor/node_modules/storage/plugins/themes)
        run: |
          cd release/exiloncms

          # Create update package - ONLY code updates, NO data, NO user-installed extensions
          zip -r ../../exiloncms-update-${{ github.ref_name }}.zip \
            app/ \
            config/ \
            database/migrations/ \
            routes/ \
            resources/ \
            public/build/ \
            bootstrap/ \
            composer.json \
            package.json \
            CHANGELOG.md \
            -x "*.log" \
            -x "storage/**/*" \
            -x ".env" \
            -x ".env.backup" \
            -x "vendor/**/*" \
            -x "node_modules/**/*" \
            -x ".git/**/*" \
            -x "tests/**/*" \
            -x "phpunit.xml" \
            -x "composer.lock" \
            -x "package-lock.json" \
            -x "plugins/**/*" \
            -x "themes/**/*" \
            -x "public/themes/**/*"

          cd ../..

      - name: Create installer ZIP
        run: |
          # Create standalone installer ZIP with install.php as entry point (not index.php)
          cd installer
          # Create install.php copy for the ZIP (to avoid being overwritten by CMS extraction)
          cp index.php install.php
          # Create README with instructions
          cat > README.txt << 'EOF'
          # ExilonCMS Installer

          Extract all files in a folder on your server, then access:
          https://your-domain.com/install.php

          The installer will download and setup ExilonCMS automatically.
          EOF
          # Create ZIP including both index.php and install.php
          zip -r ../exiloncms-installer-${{ github.ref_name }}.zip .
          # Clean up temporary install.php
          rm -f install.php

      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << EOF
          ## ðŸš€ ExilonCMS ${{ steps.get_version.outputs.version }}

          ðŸ“– [Installation Documentation](https://exiloncms.fr/docs/installation) | ðŸ“ [Changelog](https://github.com/Exilon-Studios/ExilonCMS/blob/main/CHANGELOG.md)

          ### Quick Start
          - **Standalone Installer**: Download \`exiloncms-installer-${{ steps.get_version.outputs.version }}.zip\` below, extract, and access \`install.php\` in your browser
          - **Full Package**: Download \`exiloncms-${{ steps.get_version.outputs.version }}.zip\` below and follow the manual setup guide

          ### Upgrading
          If you're already running ExilonCMS, use the built-in update system in the admin panel at \`/admin/updates\`.

          **Alternative**: Download the lightweight \`exiloncms-update-${{ steps.get_version.outputs.version }}.zip\` and extract it over your installation, then run:
          \`\`\`bash
          composer install --no-dev
          npm install
          npm run build
          php artisan migrate --force
          php artisan cache:clear
          \`\`\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: ExilonCMS ${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            exiloncms-${{ steps.get_version.outputs.version }}.zip
            exiloncms-installer-${{ steps.get_version.outputs.version }}.zip
            exiloncms-update-${{ steps.get_version.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger marketplace webhook
        run: |
          # Notify marketplace of new release
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"version":"${{ steps.get_version.outputs.version }}","download_url":"https://github.com/Exilon-Studios/ExilonCMS/releases/download/${{ steps.get_version.outputs.version }}/exiloncms-${{ steps.get_version.outputs.version }}.zip"}' \
            https://marketplace.exiloncms.fr/api/webhook/release \
            || echo "Marketplace webhook notification skipped"
